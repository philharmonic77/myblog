{{/*
  Hugo image gallery shortcode
  Usage example:
  {{< gallery images="a.jpg,b.jpg,c.jpg" captions="A,B,C" cols="3" >}}
  {{< gallery images="a.jpg,b.jpg,c.jpg,d.jpg" layout="masonry" cols="3" >}}
  {{< gallery images="a.jpg,b.jpg,c.jpg" layout="wechat" >}}
*/}}

{{ $page := .Page }}
{{ $imagesParam := .Get "images" }}
{{ if not $imagesParam }}
  {{ errorf "gallery shortcode requires images param" }}
{{ end }}

{{ $rawImages := split $imagesParam "," }}
{{ $images := slice }}
{{ range $rawImages }}
  {{ $img := trim . " " }}
  {{ if $img }}
    {{ $images = $images | append $img }}
  {{ end }}
{{ end }}

{{ if eq (len $images) 0 }}
  {{ errorf "gallery shortcode requires at least one image" }}
{{ end }}

{{ $captions := slice }}
{{ with .Get "captions" }}
  {{ $captions = split . "," }}
{{ end }}

{{ $alts := slice }}
{{ with .Get "alts" }}
  {{ $alts = split . "," }}
{{ end }}

{{ $count := len $images }}
{{ $colsParam := .Get "cols" }}
{{ $colsFinal := $colsParam }}
{{ if not $colsFinal }}
  {{ if eq $count 1 }}
    {{ $colsFinal = "1" }}
  {{ else if eq $count 2 }}
    {{ $colsFinal = "2" }}
  {{ else if eq $count 3 }}
    {{ $colsFinal = "3" }}
  {{ else if eq $count 4 }}
    {{ $colsFinal = "2" }}
  {{ else }}
    {{ $colsFinal = "3" }}
  {{ end }}
{{ end }}

{{ $ratio := .Get "ratio" }}
{{ $layout := .Get "layout" | default "grid" }}
{{ $zoom := .Get "zoom" | default "true" }}

<div class="img-gallery-wrap">
  <div class="img-gallery{{ if eq $layout "masonry" }} masonry{{ end }}{{ if eq $layout "wechat" }} wechat{{ end }}" style="--gallery-cols: {{ $colsFinal }};" data-count="{{ $count }}" data-layout="{{ $layout }}">
    {{ range $i, $src := $images }}
      {{ $srcURL := "" }}
      {{ if hasPrefix $src "/" }}
        {{ $srcURL = $src | relURL }}
      {{ else }}
        {{ $res := or ($page.Resources.GetMatch $src) ($page.Resources.GetMatch (printf "**/%s" $src)) }}
        {{ if $res }}
          {{ $srcURL = $res.RelPermalink }}
        {{ else }}
          {{ $srcURL = $src | relURL }}
        {{ end }}
      {{ end }}

      {{ $caption := "" }}
      {{ if lt $i (len $captions) }}
        {{ $caption = trim (index $captions $i) " " }}
      {{ end }}

      {{ $alt := "" }}
      {{ if lt $i (len $alts) }}
        {{ $alt = trim (index $alts $i) " " }}
      {{ else if $caption }}
        {{ $alt = $caption }}
      {{ end }}

      <figure class="gallery-item">
        {{ if eq $zoom "true" }}
          <a class="gallery-zoom" href="{{ $srcURL }}" data-full="{{ $srcURL }}">
            <img loading="lazy" src="{{ $srcURL }}" alt="{{ $alt }}" draggable="false"{{ if $ratio }} style="aspect-ratio: {{ $ratio }}; object-fit: cover;"{{ end }}>
          </a>
        {{ else }}
          <img loading="lazy" src="{{ $srcURL }}" alt="{{ $alt }}" draggable="false"{{ if $ratio }} style="aspect-ratio: {{ $ratio }}; object-fit: cover;"{{ end }}>
        {{ end }}
        {{ if $caption }}
          <figcaption class="gallery-caption">{{ $caption }}</figcaption>
        {{ end }}
      </figure>
    {{ end }}
  </div>
</div>

{{ if eq $zoom "true" }}
<script>
if (!window.__galleryLightboxInit) {
  window.__galleryLightboxInit = true;
  (function () {
    function ensureLightbox() {
      var existing = document.querySelector('.gallery-lightbox');
      if (existing) return existing;
      var lb = document.createElement('div');
      lb.className = 'gallery-lightbox';
      lb.innerHTML = '<button class=\"gallery-lightbox-btn prev\" type=\"button\" aria-label=\"Previous\"></button><div class=\"gallery-lightbox-inner\"><img alt=\"\"><span class=\"img-watermark\"><img class=\"img-watermark-icon\" src=\"/img/watermark.webp\" alt=\"\" decoding=\"async\">PHIL77</span></div><button class=\"gallery-lightbox-btn next\" type=\"button\" aria-label=\"Next\"></button>';
      function closeLightbox() {
        lb.classList.remove('open');
        document.body.classList.remove('gallery-lightbox-open');
      }
      lb.addEventListener('click', function (e) {
        if (e.target !== lb) return;
        closeLightbox();
      });
      lb.addEventListener('contextmenu', function (e) {
        e.preventDefault();
      });
      document.body.appendChild(lb);
      lb.addEventListener('touchmove', function (e) {
        if (lb.classList.contains('open')) e.preventDefault();
      }, { passive: false });
      lb.addEventListener('wheel', function (e) {
        if (lb.classList.contains('open')) e.preventDefault();
      }, { passive: false });
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') showPrev();
        if (e.key === 'ArrowRight') showNext();
      });
      return lb;
    }

    function setImage(lb, item) {
      var img = lb.querySelector('img');
      var inner = lb.querySelector('.gallery-lightbox-inner');
      img.style.opacity = '0';
      img.src = item.src;
      img.alt = item.alt || '';
      if (inner) {
        inner.style.transform = 'translate(0px,0px) scale(1)';
      }
      if (img.complete) {
        requestAnimationFrame(function () {
          img.style.opacity = '1';
          updateLightboxWatermark(lb);
        });
      } else {
        img.onload = function () {
          img.style.opacity = '1';
          updateLightboxWatermark(lb);
        };
      }
      lb.__zoomScale = 1;
      lb.__zoomX = 0;
      lb.__zoomY = 0;
      applyTransform(lb);
    }

    function clamp(val, min, max) {
      return Math.max(min, Math.min(max, val));
    }

    function updateLightboxWatermark(lb) {
      var img = lb.querySelector('.gallery-lightbox-inner img');
      if (!img) return;
      var w = img.clientWidth || img.naturalWidth || 0;
      if (!w) return;
      var font = Math.max(10, Math.min(16, Math.round(w * 0.035)));
      var icon = Math.max(12, Math.min(20, Math.round(w * 0.05)));
      lb.style.setProperty('--lb-watermark-font', font + 'px');
      lb.style.setProperty('--lb-watermark-icon', icon + 'px');
    }

    function applyTransform(lb) {
      var inner = lb.querySelector('.gallery-lightbox-inner');
      if (!inner) return;
      inner.style.transform = 'translate(' + (lb.__zoomX || 0) + 'px,' + (lb.__zoomY || 0) + 'px) scale(' + (lb.__zoomScale || 1) + ')';
      if ((lb.__zoomScale || 1) > 1) lb.classList.add('zoomed');
      else lb.classList.remove('zoomed');
    }

    function getGalleryItems(link) {
      var gallery = link.closest('.img-gallery');
      if (!gallery) return [link];
      return Array.prototype.slice.call(gallery.querySelectorAll('.gallery-zoom'));
    }

    function showAt(lb, items, index) {
      if (!items.length) return;
      if (items.length <= 1) lb.classList.add('single');
      else lb.classList.remove('single');
      var i = ((index % items.length) + items.length) % items.length;
      lb.__galleryItems = items;
      lb.__galleryIndex = i;
      lb.classList.toggle('at-start', i === 0);
      lb.classList.toggle('at-end', i === items.length - 1);
      var link = items[i];
      setImage(lb, { src: link.getAttribute('data-full') || link.getAttribute('href'), alt: link.querySelector('img') && link.querySelector('img').alt });
    }

    function showPrev() {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb || !lb.__galleryItems) return;
      if (lb.__galleryIndex <= 0) return;
      showAt(lb, lb.__galleryItems, lb.__galleryIndex - 1);
    }

    function showNext() {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb || !lb.__galleryItems) return;
      if (lb.__galleryIndex >= lb.__galleryItems.length - 1) return;
      showAt(lb, lb.__galleryItems, lb.__galleryIndex + 1);
    }

    function onClick(e) {
      var link = e.target.closest('.gallery-zoom');
      if (!link) return;
      e.preventDefault();
      var lb = ensureLightbox();
      var items = getGalleryItems(link);
      var index = items.indexOf(link);
      showAt(lb, items, index);
      lb.classList.add('open');
      document.body.classList.add('gallery-lightbox-open');
      updateLightboxWatermark(lb);
    }

    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('gallery-lightbox-btn')) {
        if (e.target.classList.contains('prev')) showPrev();
        if (e.target.classList.contains('next')) showNext();
      }
    });

    document.addEventListener('touchstart', function (e) {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb) return;
      var touch = e.touches && e.touches[0];
      if (!touch) return;
      if (e.touches.length === 2) {
        var t1 = e.touches[0];
        var t2 = e.touches[1];
        lb.__pinching = true;
        lb.__pinchStartDist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
        lb.__pinchStartScale = lb.__zoomScale || 1;
      } else {
        lb.__touchStartX = touch.clientX;
        lb.__touchStartY = touch.clientY;
        lb.__panStartX = lb.__zoomX || 0;
        lb.__panStartY = lb.__zoomY || 0;
      }
    }, { passive: true });

    document.addEventListener('touchend', function (e) {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb) return;
      if (!lb.__galleryItems || lb.__galleryItems.length <= 1) return;
      if ((lb.__zoomScale || 1) > 1.01) return;
      if (lb.__pinching) {
        lb.__pinching = false;
        return;
      }
      var touch = e.changedTouches && e.changedTouches[0];
      if (!touch) return;
      var dx = touch.clientX - (lb.__touchStartX || 0);
      var dy = touch.clientY - (lb.__touchStartY || 0);
      if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
        if (dx > 0) showPrev();
        else showNext();
      }
      lb.__touchStartX = 0;
      lb.__touchStartY = 0;
    }, { passive: true });

    document.addEventListener('touchmove', function (e) {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb) return;
      if (e.touches.length === 2) {
        var t1 = e.touches[0];
        var t2 = e.touches[1];
        var dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
        var scale = clamp((lb.__pinchStartScale || 1) * (dist / (lb.__pinchStartDist || dist)), 1, 3);
        lb.__zoomScale = scale;
        applyTransform(lb);
        e.preventDefault();
      } else if ((lb.__zoomScale || 1) > 1) {
        var touch = e.touches[0];
        lb.__zoomX = (lb.__panStartX || 0) + (touch.clientX - (lb.__touchStartX || 0));
        lb.__zoomY = (lb.__panStartY || 0) + (touch.clientY - (lb.__touchStartY || 0));
        applyTransform(lb);
        e.preventDefault();
      }
    }, { passive: false });

    document.addEventListener('mousedown', function (e) {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb) return;
      if ((lb.__zoomScale || 1) <= 1.01) return;
      lb.__dragging = true;
      lb.__dragStartX = e.clientX;
      lb.__dragStartY = e.clientY;
      lb.__panStartX = lb.__zoomX || 0;
      lb.__panStartY = lb.__zoomY || 0;
      e.preventDefault();
    });

    document.addEventListener('mousemove', function (e) {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb || !lb.__dragging) return;
      lb.__zoomX = (lb.__panStartX || 0) + (e.clientX - (lb.__dragStartX || 0));
      lb.__zoomY = (lb.__panStartY || 0) + (e.clientY - (lb.__dragStartY || 0));
      applyTransform(lb);
    });

    document.addEventListener('mouseup', function () {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb) return;
      lb.__dragging = false;
    });

    document.addEventListener('wheel', function (e) {
      var lb = document.querySelector('.gallery-lightbox.open');
      if (!lb) return;
      var delta = e.deltaY > 0 ? -0.1 : 0.1;
      lb.__zoomScale = clamp((lb.__zoomScale || 1) + delta, 1, 3);
      applyTransform(lb);
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('click', onClick);
  })();
}
</script>
{{ end }}

{{ if eq $layout "wechat" }}
<script>
if (!window.__wechatGallerySizeInit) {
  window.__wechatGallerySizeInit = true;
  (function () {
    function classify(img) {
      var item = img.closest('.gallery-item');
      if (!item) return;
      var w = img.naturalWidth;
      var h = img.naturalHeight;
      if (!w || !h) return;
      item.classList.remove('is-portrait', 'is-landscape');
      item.classList.add(w >= h ? 'is-landscape' : 'is-portrait');
    }

    function init() {
      var imgs = document.querySelectorAll('.img-gallery.wechat[data-count="1"] img');
      if (!imgs.length) return;
      imgs.forEach(function (img) {
        if (img.complete) {
          classify(img);
        } else {
          img.addEventListener('load', function () { classify(img); }, { once: true });
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
}
</script>
{{ end }}
